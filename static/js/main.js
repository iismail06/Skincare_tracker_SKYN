let toastQueue=[],activeToast=null,toastContainer=null;const cssVarCache={};function getCssVar(e){if(void 0!==cssVarCache[e])return cssVarCache[e];try{const t=getComputedStyle(document.documentElement).getPropertyValue(e);return cssVarCache[e]=t?t.trim().replace(/^"|"$/g,""):null,cssVarCache[e]}catch(t){return cssVarCache[e]=null,null}}function initToastContainer(){toastContainer||(toastContainer=document.createElement("div"),toastContainer.className="toast-container",toastContainer.style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    z-index: 1001;\n  ",document.body.appendChild(toastContainer))}function processToastQueue(){if(activeToast||0===toastQueue.length)return;const{message:e,type:t}=toastQueue.shift();activeToast=document.createElement("div"),activeToast.className=`toast ${t}`,activeToast.textContent=e,activeToast.style.cssText=`\n    background: ${"success"===t?"#28a745":"#dc3545"};\n    color: white;\n    padding: 1rem;\n    border-radius: 4px;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n  `,toastContainer.appendChild(activeToast),requestAnimationFrame(()=>{activeToast.offsetHeight,activeToast.style.opacity="1"}),setTimeout(()=>{activeToast.style.opacity="0",setTimeout(()=>{toastContainer.removeChild(activeToast),activeToast=null,processToastQueue()},300)},3e3)}function showSuccessMessage(e){initToastContainer(),toastQueue.push({message:e,type:"success"}),activeToast||processToastQueue()}function showErrorMessage(e){const t=document.createElement("div");t.className="toast error",t.textContent=e,t.style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background: #dc3545;\n    color: white;\n    padding: 1rem;\n    border-radius: 4px;\n    z-index: 1001;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n  ",document.body.appendChild(t),setTimeout(()=>t.style.opacity="1",10),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>document.body.removeChild(t),300)},5e3)}function getCsrfToken(){const e="csrftoken";let t=null;if(document.cookie&&""!==document.cookie){const n=document.cookie.split(";");for(let o=0;o<n.length;o++){const r=n[o].trim();if(r.substring(0,10)===e+"="){t=decodeURIComponent(r.substring(10));break}}}return t}function debounce(e,t){let n;return function(...o){const r=this;clearTimeout(n),n=setTimeout(()=>e.apply(r,o),t)}}function initTheme(){const e=document.getElementById("theme-toggle"),t=document.body;if(!e)return;"dark"===(localStorage.getItem("theme")||"light")?(t.classList.add("dark-theme"),e.textContent="☀️"):e.textContent="🌙",e.removeEventListener("click",e._handler||(()=>{})),e._handler=function(){t.classList.toggle("dark-theme"),t.classList.contains("dark-theme")?(e.textContent="☀️",localStorage.setItem("theme","dark")):(e.textContent="🌙",localStorage.setItem("theme","light"))},e.addEventListener("click",e._handler)}function initNavigation(){const e=document.getElementById("hamburger-menu"),t=document.getElementById("nav-links");if(!e||!t)return;const n=function(){const n=!t.classList.contains("active");e.classList.toggle("active",n),t.classList.toggle("active",n),e.setAttribute("aria-expanded",String(n)),t.setAttribute("aria-hidden",String(!n)),document.body.style.overflow=n?"hidden":""};e.removeEventListener("click",e._handler||(()=>{})),e._handler=n,e.addEventListener("click",n);t.querySelectorAll("a").forEach(n=>{n.removeEventListener("click",n._closeHandler||(()=>{})),n._closeHandler=function(){e.classList.remove("active"),t.classList.remove("active"),e.setAttribute("aria-expanded","false"),t.setAttribute("aria-hidden","true"),document.body.style.overflow=""},n.addEventListener("click",n._closeHandler)});const o=function(n){!(t.contains(n.target)||e.contains(n.target))&&t.classList.contains("active")&&(e.classList.remove("active"),t.classList.remove("active"),e.setAttribute("aria-expanded","false"),t.setAttribute("aria-hidden","true"),document.body.style.overflow="")};document.removeEventListener("click",document._navOutsideHandler||(()=>{})),document._navOutsideHandler=o,document.addEventListener("click",o);const r=function(){window.innerWidth>768&&t.classList.contains("active")&&(e.classList.remove("active"),t.classList.remove("active"),e.setAttribute("aria-expanded","false"),t.setAttribute("aria-hidden","true"),document.body.style.overflow="")};window.removeEventListener("resize",window._navResizeHandler||(()=>{})),window._navResizeHandler=r,window.addEventListener("resize",r)}function initRoutines(){document.querySelectorAll(".routine-form").forEach(e=>{e.addEventListener("submit",handleRoutineFormSubmit)}),document.addEventListener("change",function(e){const t=e.target;if(t&&t.classList&&t.classList.contains("step-checkbox")){const e=t.getAttribute("data-step-id");e?toggleStepCompletion(e,t):handleRoutineStepUpdate(t)}}),document.addEventListener("click",function(e){const t=e.target.closest&&e.target.closest(".complete-btn");if(!t)return;e.preventDefault();const n=t.getAttribute("data-routine-id"),o=t.getAttribute("data-routine-type");n&&o&&markRoutineComplete(n,o)})}function handleRoutineStepUpdate(e){const t=e&&e.dataset?e.dataset.stepId:null,n=!(!e||!e.checked),o=e.closest(".routine-step");t?fetch("/routines/toggle-step/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCsrfToken()},body:JSON.stringify({step_id:t})}).then(e=>e.json()).then(r=>{r&&r.success?(o&&o.classList.toggle("completed",n),showSuccessMessage(r.message||"Routine step updated"),updateProgressDisplay(),document.dispatchEvent(new CustomEvent("routineStepUpdated",{detail:{stepId:t,completed:n}}))):(showErrorMessage(r&&(r.error||r.message)||"Could not update routine step"),e.checked=!n)}).catch(t=>{console.error("Error updating routine step:",t),showErrorMessage("Failed to update routine step"),e.checked=!n}):console.warn("Step ID missing on checkbox")}function toggleStepCompletion(e,t){const n=getCsrfToken();if(!n)return console.error("CSRF token not found"),void(t&&(t.checked=!t.checked));fetch("/routines/toggle-step/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":n},body:JSON.stringify({step_id:e})}).then(function(t){return t.ok?t.json():fallbackToggleStep(e,n)}).then(function(e){e&&e.success?updateProgressDisplay():e&&!1===e.success&&(console.error("Failed to update step",e.error||e.message),t&&(t.checked=!t.checked))}).catch(function(e){console.error("Network error while toggling step:",e),t&&(t.checked=!t.checked)})}function fallbackToggleStep(e,t){const n=document.querySelector(`[data-step-id="${e}"]`),o=!!n&&n.checked;return fetch("/routines/toggle-step-completion/",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-CSRFToken":t},body:`step_id=${encodeURIComponent(e)}&completed=${o?"1":"0"}`}).then(e=>e.json()).then(e=>(e&&e.success?updateProgressDisplay():n&&(n.checked=!o),e||{success:!1}))}function markRoutineComplete(e,t){const n=getCsrfToken();n?fetch("/routines/mark-complete/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":n},body:JSON.stringify({routine_id:e,routine_type:t})}).then(e=>{if(!e.ok)throw new Error("Network error");return e.json()}).then(e=>{e&&e.success?window.location.reload():showErrorMessage(e&&(e.error||e.message)||"Failed to mark routine complete")}).catch(e=>{console.error("Error marking routine complete:",e),showErrorMessage("Could not connect to server")}):console.error("CSRF token not found")}function updateProgressDisplay(){const e=document.querySelectorAll(".step-checkbox").length,t=document.querySelectorAll(".step-checkbox:checked").length,n=e>0?Math.round(t/e*100):0,o=document.querySelector(".progress-fill");o&&(o.style.width=n+"%");const r=document.querySelector(".progress-text");r&&(r.textContent=`${t} of ${e} steps completed`)}function handleRoutineFormSubmit(e){const t=e.target;if(t&&("true"===t.dataset.noAjax||"true"===t.getAttribute("data-no-ajax")))return;e.preventDefault();const n=new FormData(t);fetch(t.action,{method:t.method,body:n,headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>e.json()).then(e=>{if(!e||!0!==e.success&&"success"!==e.status){showErrorMessage(e&&(e.error||e.message)||"Error saving routine")}else{try{const t=document.querySelector(".form-container.add-routine-page");if(t){let n=t.querySelector(".inline-success");n||(n=document.createElement("div"),n.className="inline-success",n.setAttribute("role","status"),n.setAttribute("aria-live","polite"),n.style.marginBottom="1rem",t.insertBefore(n,t.querySelector(".form-card")));const o=(e.name||"").trim(),r=e.detail_url||e.redirect_url||"/routines/dashboard/";n.innerHTML='<div class="d-flex" style="align-items:center; gap:.75rem; justify-content:space-between; flex-wrap:wrap;"><div>'+(o?"<strong>"+escapeHtml(o)+"</strong> — Added. ":"Routine — Added. ")+'<span class="muted">You can view it on your dashboard.</span></div><div class="actions"><a class="btn btn-primary" href="'+r+'">View on Dashboard</a></div></div>'}}catch(e){}try{const e=t;for(let t=1;t<=10;t++){const n=e.querySelector('[name="step'+t+'"]'),o=e.querySelector('[name="product'+t+'"]');n&&(n.value=""),o&&(o.value="")}}catch(e){}if(e.html){const t=document.querySelector("#routines-container");t&&(t.innerHTML=e.html,initRoutines())}}}).catch(e=>{console.error("Error:",e),showErrorMessage("An error occurred while processing your request")})}function initProducts(){initProductForms(),initProductSearch(),initProductSuggestions()}function initProductForms(){document.querySelectorAll(".product-form").forEach(e=>{e.addEventListener("submit",handleProductFormSubmit)})}function handleProductFormSubmit(e){e.preventDefault();const t=e.target,n=new FormData(t),o=t.querySelector('button[type="submit"]'),r=o.textContent;o.textContent="Saving...",o.disabled=!0,fetch(t.action,{method:t.method,body:n,headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>e.json()).then(e=>{"success"===e.status?(showSuccessMessage(e.message||"Product saved successfully"),e.redirect_url&&(window.location.href=e.redirect_url)):(showErrorMessage(e.message||"Error saving product"),e.errors&&Object.entries(e.errors).forEach(([e,n])=>{const o=t.querySelector(`[name="${e}"]`);if(o){o.classList.add("is-invalid");let r=t.querySelector(`#${e}-error`);r||(r=document.createElement("div"),r.id=`${e}-error`,r.className="invalid-feedback",o.parentNode.appendChild(r)),r.textContent=n.join(" ")}}))}).catch(e=>{console.error("Error:",e),showErrorMessage("An error occurred while processing your request")}).finally(()=>{o.textContent=r,o.disabled=!1})}function initProductSearch(){const e=document.querySelector("#product-search");e&&e.addEventListener("input",debounce(function(){const e=this.value.trim();document.querySelector("#products-list")&&(e.length<2?document.querySelectorAll(".product-card").forEach(e=>{e.style.display=""}):document.querySelectorAll(".product-card").forEach(t=>{const n=t.querySelector(".product-name").textContent.toLowerCase(),o=t.querySelector(".product-brand")?.textContent.toLowerCase()||"";n.includes(e.toLowerCase())||o.includes(e.toLowerCase())?t.style.display="":t.style.display="none"}))},300))}function initProductSuggestions(){const e=document.getElementById("category-browse"),t=document.getElementById("suggestions-loading"),n=document.getElementById("product-suggestions"),o=document.getElementById("suggestions-grid"),r=document.getElementById("product-form");function s(e,t,n){const o=e.querySelector('[name="'+t+'"]');if(o){o.value=n;const e=new Event("change",{bubbles:!0});o.dispatchEvent(e)}}function i(e){const t=document.createElement("div");return t.textContent=String(e),t.innerHTML}e&&r&&o&&n&&t&&e.addEventListener("change",function(){const a=this.value;if(!a)return n.style.display="none",void n.setAttribute("aria-hidden","true");t.style.display="block",t.setAttribute("aria-hidden","false"),n.style.display="none",n.setAttribute("aria-hidden","true"),o.innerHTML="",fetch("/api/products/browse/"+encodeURIComponent(a)+"/").then(function(e){if(!e.ok)throw new Error("Network response was not ok");return e.json()}).then(function(a){t.style.display="none",t.setAttribute("aria-hidden","true"),a&&0!==a.length?a.forEach(function(t){const n=function(t,n){const o=document.createElement("div");o.className="suggestion-card",o.style.cursor="pointer";const r=t.product_type_display||t.product_type||"";return o.innerHTML="<h5>"+i(t.name||"")+"</h5><p><strong>Brand:</strong> "+i(t.brand||"")+"</p>"+(t.ingredients?"<p><strong>Key ingredients:</strong> "+i(t.ingredients.substring(0,100))+(t.ingredients.length>100?"...":"")+"</p>":"")+'<div class="product-type">'+i(r)+"</div>",o.addEventListener("click",function(){!function(t,n){s(t,"name",n.name||""),s(t,"brand",n.brand||""),s(t,"product_type",n.product_type||""),n.ingredients&&s(t,"ingredients",n.ingredients);n.description&&s(t,"description",n.description);e.value="";const o=document.getElementById("product-suggestions");o&&(o.style.display="none",o.setAttribute("aria-hidden","true"))}(n,t),n.scrollIntoView({behavior:"smooth",block:"center"});const o=getCssVar("--accent-color-bg-lighter");if(o){const e=n.style.backgroundColor;n.style.backgroundColor=o,setTimeout(function(){n.style.backgroundColor=e},2e3)}}),o}(t,r);o.appendChild(n)}):o.innerHTML='<p class="muted-message">No products found for this category. Try importing some first!</p>',n.style.display="block",n.setAttribute("aria-hidden","false")}).catch(function(e){console.error("Error fetching products:",e),t.style.display="none",t.setAttribute("aria-hidden","true"),o.innerHTML='<p class="error-message">Error loading suggestions. Please try again.</p>',n.style.display="block",n.setAttribute("aria-hidden","false")})})}function initPageSpecificFunctions(){if(document.querySelector(".dashboard-page")){try{"function"==typeof initCalendar&&initCalendar()}catch(e){}initRoutines()}document.querySelector(".products-page")&&initProducts(),document.querySelector(".routines-products-page")&&(initRoutines(),initProducts()),(document.getElementById("product-form")||document.getElementById("category-browse"))&&initProducts(),document.querySelector(".add-routine-page")&&initRoutineNameSuggestions()}function setupCommonElements(){try{const e=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));window.bootstrap&&"function"==typeof window.bootstrap.Tooltip&&e.forEach(e=>new window.bootstrap.Tooltip(e))}catch(e){console.debug("Tooltips unavailable:",e)}try{const e=[].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));window.bootstrap&&"function"==typeof window.bootstrap.Popover&&e.forEach(e=>new window.bootstrap.Popover(e))}catch(e){console.debug("Popovers unavailable:",e)}setupRoutineStepDropdowns()}function initRoutineNameSuggestions(){const e=document.getElementById("routine_name"),t=document.getElementById("routine_type"),n=document.getElementById("routine-name-suggestions");if(!(e&&t&&n))return;const o={morning:["Busy Morning","Coming Morning","Routine Morning for Work","Going Morning to Work","Morning for Work","Morning Before Work","Early AM Reset","Sunrise Routine"],evening:["Night Shift","Post Night Shift Morning","Late Night Reset","Evening Wind Down","Post-Shift Night Care"],weekly:["Weekly Treatment","Sunday Reset","Weekly Exfoliation"],monthly:["Monthly Refresh","Monthly Mask","Monthly Reset"],hair:["Hair Care","Scalp Soothe","Glossy Hair Routine"],body:["Body Care","Body Glow","Self-care Body Routine"],special:["Special Care","Event Prep","SOS Routine"],seasonal:["Seasonal Routine","Winter Care","Summer Skin"]};function r(){if(!n)return;const e=function(){const e=(t.value||"").toLowerCase(),n=o[e];return Array.isArray(n)&&n.length?n:["Morning Routine","Evening Reset","Weekly Treatment","Monthly Refresh"]}();n.innerHTML="",e.forEach(e=>{const t=document.createElement("option");t.value=e,n.appendChild(t)})}r(),t.addEventListener("change",function(){r()})}function setupRoutineStepDropdowns(){const e=document.querySelectorAll(".routine-step-select");e.length&&e.forEach(e=>{e.addEventListener("change",function(){const e=this.options[this.selectedIndex],t=document.querySelector("#product-for-"+this.dataset.stepId);t&&(t.value=e.dataset.productId||"")})})}function initProductSelectsForProfile(){const e=document.getElementById("steps-container");if(!e)return;const t=document.getElementById("user-products-data");let n=[];const o={};try{if(t&&t.textContent){const e=JSON.parse(t.textContent);Array.isArray(e)&&(n=e)}}catch(e){}if(!n.length){const t=e.querySelector('select.product-select, select[id^="product"]');if(t&&t.options&&t.options.length>1){const e=[];for(const n of t.options){if(!n.value)continue;const t=(n.textContent||"").trim();let o="",r=t;const s=t.indexOf(" - ");s>-1&&(o=t.slice(0,s).trim(),r=t.slice(s+3).trim()),e.push([n.value,o,r])}e.length&&(n=e)}}function r(e){let t=`<option value="" disabled${!!e?"":" selected"}>Add product</option>`;if(n.length){t+='<optgroup label="My products">';for(const o of n){const[n,r,s]=o,i=`${r||""}${r&&s?" — ":""}${s||""}`.trim()||"Untitled Product";t+=`<option value="${n}"${String(e||"")===String(n)?" selected":""}>${i}</option>`}t+="</optgroup>"}else t+='<option value="" disabled>No products yet</option>';return t}e.querySelectorAll("select.product-select").forEach(e=>{const t=e.options?e.options.length:0;if(!n.length||t>1)return;const o=e.getAttribute("data-selected")||e.value||"";e.innerHTML=r(o),o&&(e.value=o)});const s=document.getElementById("add-step-btn"),i=document.getElementById("remove-step-btn");function a(e){const t=(e||"").toLowerCase().trim();if(!t)return null;const n={"gentle cleanse":"cleanser","double cleanse":"cleanser","deep cleanse":"cleanser",cleanser:"cleanser","face wash":"cleanser",toner:"toner",essence:"essence","vitamin c serum":"vitamin_c","treatment serum":"serum","intensive serum":"serum","light moisturizer":"moisturizer",moisturizer:"moisturizer","spf / sunscreen":"sunscreen","retinol / acid treatment":"retinol",active:"serum",actives:"serum","spot treatment":"spot_treatment","eye cream":"eye_cream","face oil":"oil","lip treatment":"lip_treatment",exfoliation:"exfoliant","clay mask":"mask","hydrating mask":"mask","intensive treatment":"treatment","professional treatment":"professional_treatment","deep repair mask":"mask","barrier repair":"barrier_repair","reset treatment":"reset_treatment","body wash":"body_wash","body scrub":"body_scrub","body lotion":"body_lotion","body oil":"body_oil",deodorant:"deodorant","hand cream":"hand_cream","foot treatment":"foot_treatment","clarifying shampoo":"clarifying_shampoo",shampoo:"shampoo",conditioner:"conditioner","hair mask":"hair_mask","deep hair mask":"deep_hair_mask","leave-in treatment":"leave_in_treatment","hair oil":"hair_oil","scalp treatment":"scalp_treatment","heat protectant":"heat_protectant","prep treatment":"primer","priming serum":"primer","glow treatment":"glow_treatment","hydration boost":"hydration_boost","setting treatment":"setting_treatment","season prep":"season_prep","climate adjustment":"climate_adjustment","humidity control":"humidity_control","weather protection":"weather_protection","transition treatment":"transition_treatment"};return n[t]?n[t]:t.includes("cleanse")||t.includes("wash")?"cleanser":t.includes("toner")?"toner":t.includes("essence")?"essence":t.includes("vitamin c")||t.includes("ascorbic")?"vitamin_c":t.includes("serum")||t.includes("active")||t.includes("niacinamide")||t.includes("hyaluronic")||t.includes("azelaic")||t.includes("tranexamic")?"serum":t.includes("moistur")?"moisturizer":t.includes("spf")||t.includes("sunscreen")?"sunscreen":t.includes("retinol")||t.includes("retinoid")?"retinol":t.includes("acid")||t.includes("exfol")||t.includes("aha")||t.includes("bha")||t.includes("salicylic")||t.includes("glycolic")||t.includes("lactic")?"exfoliant":t.includes("mask")?"mask":t.includes("eye")?"eye_cream":t.includes("lip")?"lip_treatment":t.includes("oil")||t.includes("squalane")?"oil":t.includes("spot")||t.includes("benzoyl")?"spot_treatment":t.includes("body")&&t.includes("wash")?"body_wash":t.includes("body")&&t.includes("scrub")?"body_scrub":t.includes("body")&&(t.includes("lotion")||t.includes("cream"))?"body_lotion":t.includes("shampoo")?"shampoo":t.includes("conditioner")?"conditioner":t.includes("scalp")?"scalp_treatment":t.includes("heat")&&t.includes("protect")?"heat_protectant":t.includes("deodor")?"deodorant":t.includes("hand")?"hand_cream":t.includes("foot")?"foot_treatment":null}async function c(e){if(!e)return[{name:"Gentle Skin Cleanser",brand:"Cetaphil",product_type:"cleanser"},{name:"Niacinamide 10% + Zinc 1%",brand:"The Ordinary",product_type:"serum"},{name:"Daily Facial Moisturizing Lotion",brand:"CeraVe",product_type:"moisturizer"},{name:"UV Clear Broad-Spectrum SPF 46",brand:"EltaMD",product_type:"sunscreen"}];if(o[e])return o[e];try{const t=await fetch(`/api/products/browse/${encodeURIComponent(e)}/`,{credentials:"same-origin",headers:{Accept:"application/json"}});if(!t.ok)return console.debug("Suggestion fetch failed:",e,t.status),[];const n=t.headers.get("content-type")||"";if(!n.includes("application/json"))return console.debug("Suggestion response not JSON for category:",e,n),[];const r=await t.json();return o[e]=Array.isArray(r)?r:[],o[e]}catch(t){return console.debug("Suggestion fetch error for category:",e),[{name:"Gentle Skin Cleanser",brand:"Cetaphil",product_type:"cleanser"},{name:"Niacinamide 10% + Zinc 1%",brand:"The Ordinary",product_type:"serum"},{name:"Daily Facial Moisturizing Lotion",brand:"CeraVe",product_type:"moisturizer"},{name:"UV Clear Broad-Spectrum SPF 46",brand:"EltaMD",product_type:"sunscreen"}]}}function d(e,t,o){e.innerHTML=function(e,t){let o=`<option value="" disabled${e?"":" selected"}>Add product</option>`;if(n.length){o+='<optgroup label="My products">';for(const t of n){const[n,r,s]=t,i=`${r||""}${r&&s?" — ":""}${s||""}`.trim()||"Untitled Product",a=String(e||"")===String(n)?" selected":"";o+=`<option value="${n}"${a}>${i}</option>`}o+="</optgroup>"}return o+='<optgroup label="Suggestions">',Array.isArray(t)&&t.length?t.forEach((e,t)=>{const n=`${(e.brand||"").trim()}${e.brand&&e.name?" — ":""}${(e.name||"").trim()}`||"Suggested Product";o+=`<option value="suggestion::${t}" data-sug-name="${(e.name||"").replace(/"/g,"&quot;")}" data-sug-brand="${(e.brand||"").replace(/"/g,"&quot;")}" data-sug-type="${(e.product_type||"").replace(/"/g,"&quot;")}">${n}</option>`}):o+='<option value="" disabled>No suggestions for this step yet</option>',o+="</optgroup>",o}(t,o),t&&(e.value=String(t))}function l(e){const{stepField:t,productSel:o}=function(e){let t=e.querySelector('select[id^="step"]');return t||(t=e.querySelector('input[id^="id_step"], input[name^="step"]')),{stepField:t,productSel:e.querySelector('select.product-select, select[id^="product"]')}}(e);if(!o)return;const r=a(t&&t.value||""),s=o.getAttribute("data-selected")||o.value||"";if(r?c(r).then(e=>d(o,s,e)):d(o,s,[]),function(e){e.addEventListener("change",async function(){const t=e.value;if(!t||!t.startsWith("suggestion::"))return;const o=e.options[e.selectedIndex],r=(o.getAttribute("data-sug-name")||"").trim(),s=(o.getAttribute("data-sug-brand")||"").trim();let i=(o.getAttribute("data-sug-type")||"").trim()||"other";if((!new Set(["cleanser","toner","serum","moisturizer","sunscreen","exfoliant","mask","eye_cream","oil","essence","spot_treatment","retinol","vitamin_c","other"]).has(i)||i.length>20)&&(i=i.includes("vitamin")?"vitamin_c":i.includes("retinol")?"retinol":i.includes("mask")?"mask":i.includes("exfol")?"exfoliant":i.includes("toner")?"toner":i.includes("essence")?"essence":i.includes("serum")||i.includes("treatment")?"serum":"other"),r&&s)try{const t=new FormData;t.append("name",r),t.append("brand",s),t.append("product_type",i);const o=await fetch("/api/products/quick-add/",{method:"POST",headers:{"X-CSRFToken":getCsrfToken()},body:t,credentials:"same-origin"});if(!o.ok)throw new Error("quick-add failed");const a=await o.json();a&&a.success&&a.product&&a.product.id&&(n.push([a.product.id,a.product.brand||"",a.product.name||""]),d(e,a.product.id,[]))}catch(t){showErrorMessage("Could not add suggested product."),d(e,"",[])}})}(o),t){const e=async function(){const e=a(t.value),n=o.value||"",r=await c(e);d(o,n,r)},n="SELECT"===t.tagName?"change":"input";t.addEventListener(n,e)}let i=!1;o.addEventListener("focus",async function(){if(i)return;const e=a(t&&t.value||"");if(!e)return;const n=await c(e);if(n&&n.length){const e=o.value||"";d(o,e,n),i=!0}},{once:!1})}s&&s.addEventListener("click",function(){setTimeout(()=>{const t=e.querySelectorAll(".step-item"),n=t[t.length-1];if(!n)return;let o=n.querySelector("select.product-select");if(!o){const e=n.getAttribute("data-step")||t.length;o=document.createElement("select"),o.id="product"+e,o.name="product"+e,o.className="product-select",n.appendChild(o)}const s=o.getAttribute("data-selected")||o.value||"";o.innerHTML=r(s),s&&(o.value=s),l(n)},0)}),i&&i.addEventListener("click",function(){}),e.querySelectorAll(".step-item").forEach(l)}function initProfileRoutineBuilder(){const e=document.getElementById("steps-container"),t=document.getElementById("routine_type"),n=document.getElementById("add-step-btn"),o=document.getElementById("remove-step-btn"),r=document.querySelector(".step-count");if(!e||!t)return;const s={morning:["Gentle Cleanse","Toner","Essence","Vitamin C Serum","Light Moisturizer","Eye Cream","SPF / Sunscreen"],evening:["Double Cleanse","Toner","Essence","Treatment Serum","Retinol / Acid Treatment","Eye Cream","Moisturizer","Face Oil","Spot Treatment","Lip Treatment"],weekly:["Deep Cleanse","Exfoliation","Clay Mask","Hydrating Mask","Hair Mask","Body Scrub","Intensive Treatment"],monthly:["Professional Treatment","Deep Repair Mask","Intensive Serum","Barrier Repair","Reset Treatment"],hair:["Clarifying Shampoo","Shampoo","Conditioner","Deep Hair Mask","Leave-in Treatment","Hair Oil","Scalp Treatment","Heat Protectant"],body:["Body Wash","Body Scrub","Body Lotion","Body Oil","Deodorant","Hand Cream","Foot Treatment"],special:["Prep Treatment","Priming Serum","Glow Treatment","Hydration Boost","Setting Treatment","Special Occasion Mask"],seasonal:["Season Prep","Climate Adjustment","Barrier Repair","Humidity Control","Weather Protection","Transition Treatment"]};function i(){const t=e.querySelectorAll(".step-item").length;r&&(r.textContent=`${t} step${1!==t?"s":""}`),n&&(n.disabled=t>=10),o&&(o.disabled=t<=1)}function a(e){let t='<option value="">Select step</option>';return t+=(s[e]||s.morning).map(e=>`<option value="${e}">${e}</option>`).join(""),t+='<option value="custom">✏️ Custom Step...</option>',t}function c(e){e.removeEventListener("change",e._handler||(()=>{})),e._handler=function(){const t=this.id.replace("step","");let n=document.getElementById(`custom-step${t}`);"custom"===this.value?(n||(n=document.createElement("input"),n.type="text",n.id=`custom-step${t}`,n.name=`step${t}`,n.className="form-control custom-step-input",n.placeholder="Enter custom step name...",n.style.marginTop="5px",this.parentNode.insertBefore(n,this.nextSibling)),this.style.display="none",n.style.display="block",n.focus(),n.addEventListener("blur",function t(){this.value.trim()||(e.style.display="block",this.style.display="none",e.value=""),n.removeEventListener("blur",t)})):n&&(n.style.display="none",n.value="",this.style.display="block")},e.addEventListener("change",e._handler)}function d(){const n=e.querySelectorAll('.step-item select[id^="step"]'),o=a(t.value||"morning");n.forEach(e=>{e.innerHTML=o,c(e)})}d(),i(),t.addEventListener("change",d),n&&n.addEventListener("click",function(){const n=e.querySelectorAll(".step-item").length;if(n>=10)return;const o=function(e){const t=document.createElement("div");return t.className="step-item",t.setAttribute("data-step",String(e)),t.innerHTML=`<select id="step${e}" name="step${e}" class="step-select"></select>`,t}(n+1);e.appendChild(o);const r=t.value||"morning",s=o.querySelector("select");s.innerHTML=a(r),c(s),i()}),o&&o.addEventListener("click",function(){const t=e.querySelectorAll(".step-item");if(t.length<=1)return;t[t.length-1].remove(),i()})}document.addEventListener("DOMContentLoaded",function(){initTheme(),initNavigation(),initPageSpecificFunctions(),setupCommonElements();const e=document.querySelector(".progress-fill");if(e){const t=parseInt(e.getAttribute("data-progress")||"0",10);Number.isNaN(t)||(e.style.width=t+"%")}initProductSelectsForProfile()}),function(){const e=document.querySelector("#calendar");if(!e)return;let t=[],n=[],o=[],r=[];try{const e=document.getElementById("routine-events");if(e&&e.textContent){const n=JSON.parse(e.textContent);Array.isArray(n)&&(t=n)}const s=document.getElementById("expiry-events");if(s&&s.textContent){const e=JSON.parse(s.textContent);Array.isArray(e)&&(n=e)}const i=document.getElementById("weekly-due-dates");if(i&&i.textContent){const e=JSON.parse(i.textContent);Array.isArray(e)&&(o=e)}const a=document.getElementById("monthly-due-dates");if(a&&a.textContent){const e=JSON.parse(a.textContent);Array.isArray(e)&&(r=e)}}catch(e){}!t.length&&window.ROUTINE_EVENTS&&Array.isArray(window.ROUTINE_EVENTS)&&(t=window.ROUTINE_EVENTS),!n.length&&window.EXPIRY_EVENTS&&Array.isArray(window.EXPIRY_EVENTS)&&(n=window.EXPIRY_EVENTS);const s={},i={};t.forEach(function(e){e&&e.date&&(s[e.date]=e)}),n.forEach(function(e){e&&e.date&&(i[e.date]||(i[e.date]=[]),i[e.date].push(e))});const a={year:(new Date).getFullYear(),month:(new Date).getMonth()};function c(){e.innerHTML="";const t=document.createElement("div");t.className="sc-header";const n=document.createElement("button");n.textContent="<",n.addEventListener("click",function(){l(-1)});const c=document.createElement("button");c.textContent=">",c.addEventListener("click",function(){l(1)});const u=document.createElement("div");u.className="sc-title",u.textContent=new Date(a.year,a.month).toLocaleString(void 0,{month:"long",year:"numeric"}),t.appendChild(n),t.appendChild(u),t.appendChild(c),e.appendChild(t);const m=document.createElement("div");m.className="sc-dow",["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(function(e){const t=document.createElement("div");t.className="sc-dow-cell",t.textContent=e,m.appendChild(t)}),e.appendChild(m);const p=document.createElement("div");p.className="sc-grid";const g=new Date(a.year,a.month,1).getDay(),h=new Date(a.year,a.month+1,0).getDate();for(let e=0;e<g;e++){const e=document.createElement("div");e.className="sc-cell sc-other",p.appendChild(e)}const y=new Date;y.setHours(0,0,0,0);for(let e=1;e<=h;e++){const t=d(a.year,a.month,e),n=document.createElement("div");n.className="sc-cell sc-day",n.dataset.date=t,n.id="calendar-day-"+t;const o=document.createElement("div");o.className="sc-day-num",o.textContent=e,n.appendChild(o);const r=document.createElement("div");r.className="sc-day-icon";const c=s[t],l=new Date(a.year,a.month,e),u=l>y,m=l.getTime()===y.getTime();m&&n.classList.add("sc-today");let g="No events";if(c)if("completed"===c.status)r.textContent="✨",g="Completed";else if("not_done"===c.status)if(u)r.textContent="",g="Upcoming";else{r.textContent="×";const e=getCssVar("--error-color");e&&(r.style.color=e),r.style.fontSize="2rem",g="Missed"}else"morning"===c.status?(r.textContent="☀️",g="Morning routine"):"evening"===c.status&&(r.textContent="🌙",g="Evening routine");else u&&(g="Upcoming");n.appendChild(r);const h=t.split("-");let f=h[2]+"-"+h[1]+"-"+h[0]+" — "+g+(m?" • Today":"");const v=i[t]||[];if(v.length){const e=document.createElement("div");e.className="sc-expiry-badge",e.textContent="⚠️",n.appendChild(e);const t=2,o=v.slice(0,t).map(function(e){return(e.product_name||e.title||"Product")+(e.brand?" — "+e.brand:"")}),r=v.length-o.length;f+=" • "+("Expiring: "+o.join(" || ")+(r>0?" and "+r+" more":""))}n.title=f,n.setAttribute("aria-label",f),p.appendChild(n)}(Array.isArray(o)&&o.length?o:Array.isArray(window.weeklyDueDates)?window.weeklyDueDates:[]).forEach(function(e){const t=document.getElementById("calendar-day-"+e.date);if(t){const n=getCssVar("--accent-color-bg-lighter-rgb"),o=n?"rgb("+n+")":getCssVar("--accent-step-weekly");o&&(t.style.border="2px solid "+o);const r="Weekly step: "+e.step_name+" ("+e.routine_type+")";t.title=t.title?t.title+" • "+r:r,t.setAttribute("aria-label",t.title)}});(Array.isArray(r)&&r.length?r:Array.isArray(window.monthlyDueDates)?window.monthlyDueDates:[]).forEach(function(e){const t=document.getElementById("calendar-day-"+e.date);if(t){const n=getCssVar("--accent-step-monthly");n&&(t.style.border="2px solid "+n);const o="Monthly step: "+e.step_name+" ("+e.routine_type+")";t.title=t.title?t.title+" • "+o:o,t.setAttribute("aria-label",t.title)}});const f=(7-(g+h)%7)%7;for(let e=0;e<f;e++){const e=document.createElement("div");e.className="sc-cell sc-other",p.appendChild(e)}e.appendChild(p)}function d(e,t,n){return e+"-"+(t+1).toString().padStart(2,"0")+"-"+n.toString().padStart(2,"0")}function l(e){a.month+=e,a.month<0&&(a.month=11,a.year-=1),a.month>11&&(a.month=0,a.year+=1),c()}c()}(),document.addEventListener("DOMContentLoaded",function(){document.getElementById("steps-container")&&document.getElementById("routine_type")&&initProfileRoutineBuilder()});