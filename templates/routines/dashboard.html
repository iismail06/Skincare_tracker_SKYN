{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}


{% block title %}My Routines - SKYN{% endblock %}


{% block content %}
{% csrf_token %}
<div class="dashboard-container">

  <!-- Header -->
  <h1 class="page-title">Your Dashboard</h1>
  
  <!-- Progress Section -->
  <section class="progress-section">
    <div class="progress-cards">
      <div class="progress-card">
        <h4>Today's Progress</h4>
        <div class="progress-bar">
          <div class="progress-fill" data-progress="{{ today_progress|default:0 }}"></div>
        </div>
        <span class="progress-text">{{ completed_steps_today|default:0 }} of {{ total_steps_today|default:0 }} steps completed</span>
      </div>
      <div class="progress-card">
        <h4>Current Streak</h4>
        <div class="streak-counter">üî• {{ current_streak|default:0 }} day{{ current_streak|pluralize }}</div>
      </div>
      <div class="progress-card">
        <h4>This Week</h4>
        <div class="week-progress">
          {% for day in week_progress %}
            <span class="week-day {% if day.status == 'completed' %}completed{% elif day.status == 'current' %}current{% endif %}">{{ day.day }}</span>
          {% empty %}
            <!-- Fallback if week_progress is empty -->
            <span class="week-day">M</span>
            <span class="week-day">T</span>
            <span class="week-day">W</span>
            <span class="week-day">T</span>
            <span class="week-day">F</span>
            <span class="week-day">S</span>
            <span class="week-day">S</span>
          {% endfor %}
        </div>
      </div>
    </div>
  </section>

  <!-- Routines Section -->
  <section class="routines-section">
    <h2 class="section-title">Your Routines</h2>
    <div class="routine-cards">
      <!-- Morning Routine -->
      <div class="routine-card morning">
        <div class="routine-header">
          <h3>Morning Routine</h3>
          {% if morning_routine %}
            <a href="{% url 'routines:edit' morning_routine.pk %}" class="edit-btn"> Edit</a>
          {% else %}
            <button class="edit-btn" disabled style="opacity: 0.5;"> Edit</button>
          {% endif %}
        </div>
        {% if morning_routine %}
          <ul class="routine-steps">
            {% for step in morning_routine.steps.all %}
              <li class="routine-step">
                <label class="step-label">
                  <input type="checkbox" 
                         class="step-checkbox" 
                         data-step-id="{{ step.id }}"
                         {% if step.id in today_completed_step_ids %}checked{% endif %}>
                  <span class="step-text">
                    {% if step.product %}
                      {{ step.product.name }} ‚Äì {{ step.step_name }}
                    {% else %}
                      {{ step.step_name }}
                    {% endif %}
                  </span>
                </label>
              </li>
            {% endfor %}
          </ul>
          <div class="routine-actions">
            {% if morning_routine.id %}
              <button class="complete-btn" onclick="markRoutineComplete('{{ morning_routine.id }}', 'morning')">Mark Complete</button>
            {% else %}
              <button class="complete-btn" disabled>No Routine Set</button>
            {% endif %}
          </div>
        {% else %}
          <p>No morning routine yet.</p>
          <a href="{% url 'routines:add' %}?type=morning" class="add-routine-btn">‚ûï Add Morning Routine</a>
        {% endif %}
      </div>

      <!-- Evening Routine -->
      <div class="routine-card evening">
        <div class="routine-header">
          <h3>Evening Routine</h3>
          {% if evening_routine %}
            <a href="{% url 'routines:edit' evening_routine.pk %}" class="edit-btn"> Edit</a>
          {% else %}
            <button class="edit-btn" disabled style="opacity: 0.5;"> Edit</button>
          {% endif %}
        </div>
        {% if evening_routine %}
          <ul class="routine-steps">
            {% for step in evening_routine.steps.all %}
              <li class="routine-step">
                <label class="step-label">
                  <input type="checkbox" 
                         class="step-checkbox" 
                         data-step-id="{{ step.id }}"
                         {% if step.id in today_completed_step_ids %}checked{% endif %}>
                  <span class="step-text">
                    {% if step.product %}
                      {{ step.product.name }} ‚Äì {{ step.step_name }}
                    {% else %}
                      {{ step.step_name }}
                    {% endif %}
                  </span>
                </label>
              </li>
            {% endfor %}
          </ul>
          <div class="routine-actions">
            {% if evening_routine.id %}
              <button class="complete-btn" onclick="markRoutineComplete('{{ evening_routine.id }}', 'evening')">Mark Complete</button>
            {% else %}
              <button class="complete-btn" disabled>No Routine Set</button>
            {% endif %}
          </div>
        {% else %}
          <p>No evening routine yet.</p>
          <a href="{% url 'routines:add' %}?type=evening" class="add-routine-btn">‚ûï Add Evening Routine</a>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- Tips Section -->
  <section class="dashboard-section">
    <h2 class="section-title">üí° Skincare Tips</h2>
    <div class="tips-container">
      <div class="tip-card">
        <h4>üíß Hydration Tip</h4>
        <p>Apply moisturizer to slightly damp skin to lock in extra hydration.</p>
      </div>
      <div class="tip-card">
        <h4>üåô Evening Care</h4>
        <p>Remove makeup thoroughly before starting your evening routine for best results.</p>
      </div>
      <div class="tip-card">
        <h4>‚òÄÔ∏è Morning Protection</h4>
        <p>Always finish your morning routine with SPF, even on cloudy days.</p>
      </div>
      <div class="tip-card">
        <h4>üò¥ Beauty Sleep</h4>
        <p>Get 7-8 hours of quality sleep - it's when your skin repairs and regenerates itself.</p>
      </div>
      <div class="tip-card">
        <h4>üå± Ingredient Order</h4>
        <p>Apply thinnest to thickest consistency: serums before moisturizers, oils last.</p>
      </div>
      <div class="tip-card">
        <h4>üîÑ Product Rotation</h4>
        <p>Introduce new active ingredients gradually, one at a time every 2-3 weeks.</p>
      </div>
    </div>
    <!-- Placeholder for future dynamic tips functionality -->
  </section>

  <!-- Calendar Section with isolated styling -->
  <section class="calendar-section" id="calendar-wrapper">
    <h2 class="section-title">Calendar Overview</h2>
    <div id="calendar"></div>
  </section>

</div>

{% block extra_js %}
<script>
    // === SET PROGRESS BAR WIDTH ===
    // Set the progress bar width from data attribute to avoid CSS parsing issues
    document.addEventListener('DOMContentLoaded', function() {
        const progressBar = document.querySelector('.progress-fill');
        if (progressBar) {
            const progress = progressBar.getAttribute('data-progress') || 0;
            progressBar.style.width = progress + '%';
        }
    });

    // === CALENDAR INITIALIZATION ===
    // This code sets up the calendar data for display
    if (typeof window.ROUTINE_EVENTS === 'undefined') {
        window.ROUTINE_EVENTS = {};
    }
    try {
        // Get calendar data from Django backend
        window.ROUTINE_EVENTS = JSON.parse('{{ routine_events_json|default:"{}" |escapejs }}');
    } catch (e) {
        console.warn('Could not parse routine events:', e);
        window.ROUTINE_EVENTS = {};
    }

    // === TOGGLE INDIVIDUAL STEP COMPLETION ===
    // This function runs when user clicks checkbox for individual steps
    function toggleStepCompletion(stepId) {
        // Basic validation
        if (!stepId) {
            alert('Error: Step not found');
            return;
        }

        console.log('Toggling completion for step ID:', stepId);

        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            alert('Error: Security token not found');
            return;
        }

        // Send request to Django backend
        fetch('{% url "routines:toggle_step" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken.value
            },
            body: JSON.stringify({
                step_id: stepId
            })
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                console.log('Success:', data.message);
                // Update the progress display without full page reload
                updateProgressDisplay();
            } else {
                // Show error and revert checkbox
                alert('Error: ' + (data.error || 'Unknown error occurred'));
                // Find the checkbox and revert its state
                const checkbox = document.querySelector(`[data-step-id="${stepId}"]`);
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                }
            }
        })
        .catch(function(error) {
            console.error('Network error:', error);
            alert('Error: Could not connect to server');
            // Revert checkbox state on error
            const checkbox = document.querySelector(`[data-step-id="${stepId}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        });
    }

    // === UPDATE PROGRESS DISPLAY ===
    // This function updates the progress indicators without full page reload
    function updateProgressDisplay() {
        // Count completed checkboxes
        const totalCheckboxes = document.querySelectorAll('.step-checkbox').length;
        const completedCheckboxes = document.querySelectorAll('.step-checkbox:checked').length;
        
        // Update progress percentage
        const progressPercent = totalCheckboxes > 0 ? Math.round((completedCheckboxes / totalCheckboxes) * 100) : 0;
        
        // Update the progress display in the DOM
        const progressElement = document.querySelector('.progress-stat h3');
        if (progressElement) {
            progressElement.textContent = progressPercent + '%';
        }
        
        const progressText = document.querySelector('.progress-stat p');
        if (progressText) {
            progressText.textContent = `${completedCheckboxes} of ${totalCheckboxes} steps completed today`;
        }
        
        // Update progress bar if it exists
        const progressBar = document.querySelector('.progress-fill');
        if (progressBar) {
            progressBar.style.width = progressPercent + '%';
        }
    }

    // === MARK ROUTINE COMPLETE FUNCTION ===
    // This function runs when user clicks "Mark Complete" button
    function markRoutineComplete(routineId, routineType) {
        // Basic validation - make sure we have a routine ID
        if (!routineId) {
            alert('Error: Routine not found');
            return;
        }

        // Show loading state (optional - you could add a loading indicator here)
        console.log('Marking ' + routineType + ' routine as complete...');

        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            alert('Error: Security token not found');
            return;
        }

        // Send request to Django backend
        fetch('{% url "routines:mark_complete" %}', {
            method: 'POST',  // Use POST method
            headers: {
                'Content-Type': 'application/json',  // Tell server we're sending JSON
                // Get Django's CSRF token for security
                'X-CSRFToken': csrfToken.value
            },
            // Send the routine information as JSON
            body: JSON.stringify({
                routine_id: routineId,
                routine_type: routineType
            })
        })
        .then(function(response) {
            // Check if response is ok
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            // Convert response to JSON
            return response.json();
        })
        .then(function(data) {
            // Handle the response from Django
            if (data.success) {
                // Success! Refresh page to show new progress
                console.log('Success:', data.message);
                window.location.reload();
            } else {
                // Show error message to user
                alert('Error: ' + (data.error || 'Unknown error occurred'));
            }
        })
        .catch(function(error) {
            // Handle network errors or other issues
            console.error('Network error:', error);
            alert('Error: Could not connect to server');
        });
    }

    // === INITIALIZE EVENT LISTENERS ===
    // Set up event listeners for checkboxes when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Find all step checkboxes and add event listeners
        const checkboxes = document.querySelectorAll('.step-checkbox');
        checkboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const stepId = this.getAttribute('data-step-id');
                toggleStepCompletion(stepId);
            });
        });
    });
</script>
{% endblock %}

{% endblock %}
