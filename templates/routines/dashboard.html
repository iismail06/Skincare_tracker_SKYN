{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard_style.css' %}">
{% endblock %}


{% block title %}My Routines - SKYN{% endblock %}


{% block content %}
{% csrf_token %}
<div class="dashboard-container dashboard-page">

  <!-- Header -->
  <h1 class="page-title">Your Dashboard</h1>
  
  <!-- Progress Section -->
  <section class="progress-section">
    <div class="progress-cards">
      <div class="progress-card">
        <h4>Today's Progress</h4>
        <div class="progress-bar">
          <div class="progress-fill" data-progress="{{ today_progress|default:0 }}"></div>
        </div>
        <span class="progress-text">{{ completed_steps_today|default:0 }} of {{ total_steps_today|default:0 }} steps completed</span>
      </div>
      <div class="progress-card">
        <h4>Current Streak</h4>
        <div class="streak-counter">üî• {{ current_streak|default:0 }} day{{ current_streak|pluralize }}</div>
        {% if milestone_message %}
          <div class="milestone-message">
            <span class="milestone-emoji">{{ milestone_emoji }}</span>
            <span class="milestone-text">{{ milestone_message }}</span>
          </div>
        {% endif %}
      </div>
      <div class="progress-card">
        <h4>This Week</h4>
        <div class="week-progress">
          {% for day in week_progress %}
            <span class="week-day {% if day.status == 'completed' %}completed{% elif day.status == 'current' %}current{% endif %}">{{ day.day }}</span>
          {% empty %}
            <!-- Fallback if week_progress is empty -->
            <span class="week-day">M</span>
            <span class="week-day">T</span>
            <span class="week-day">W</span>
            <span class="week-day">T</span>
            <span class="week-day">F</span>
            <span class="week-day">S</span>
            <span class="week-day">S</span>
          {% endfor %}
        </div>
      </div>
    </div>
  </section>

  <!-- Routines Section -->
  <section class="routines-section">
    <h2 class="section-title">Your Routines</h2>
    <div class="routine-cards">
      <!-- Morning Routine -->
      <div class="routine-card morning">
        <div class="routine-header">
          <h3>Morning Routine</h3>
          {% if morning_routine %}
            <a href="{% url 'routines:edit' morning_routine.pk %}" class="edit-btn">Edit</a>
          {% else %}
            <span class="edit-btn disabled">Edit</span>
          {% endif %}
        </div>
        {% if morning_routine %}
          <ul class="routine-steps">
            {% for step in morning_routine.steps.all %}
              <li class="routine-step">
                <label class="step-label">
                  <input type="checkbox" 
                         class="step-checkbox" 
                         data-step-id="{{ step.id }}"
                         {% if step.id in today_completed_step_ids %}checked{% endif %}>
                  <span class="step-text">
                    {% if step.product %}
                      <span class="product-step" 
                            data-tooltip="{% if step.product.rating %}Rating: {{ step.product.rating }}/5‚≠ê{% endif %}{% if step.product.expiry_date %} | Expires: {{ step.product.expiry_date }}{% endif %}{% if step.product.ingredients %} | Ingredients: {{ step.product.ingredients|truncatewords:8 }}{% endif %}{% if step.product.skin_type %} | Best for: {{ step.product.get_skin_type_display }}{% endif %}">
                        {% if step.product.is_favorite %}üíñ{% endif %}
                        {{ step.product.name }} ‚Äì {{ step.step_name }}
                        {% if step.product.rating %}
                          <span class="inline-rating">{{ step.product.rating }}‚≠ê</span>
                        {% endif %}
                      </span>
                    {% else %}
                      {{ step.step_name }}
                    {% endif %}
                  </span>
                </label>
              </li>
            {% endfor %}
          </ul>
          <div class="routine-actions">
            {% if morning_routine.id %}
              <button class="complete-btn" onclick="markRoutineComplete('{{ morning_routine.id }}', 'morning')">Mark Complete</button>
            {% else %}
              <button class="complete-btn" disabled>No Routine Set</button>
            {% endif %}
          </div>
        {% else %}
          <p>No morning routine yet.</p>
          <a href="{% url 'routines:add' %}?type=morning" class="add-routine-btn">‚ûï Add Morning Routine</a>
        {% endif %}
      </div>

      <!-- Evening Routine -->
      <div class="routine-card evening">
        <div class="routine-header">
          <h3>Evening Routine</h3>
          {% if evening_routine %}
            <a href="{% url 'routines:edit' evening_routine.pk %}" class="edit-btn">Edit</a>
          {% else %}
            <span class="edit-btn disabled">Edit</span>
          {% endif %}
        </div>
        {% if evening_routine %}
          <ul class="routine-steps">
            {% for step in evening_routine.steps.all %}
              <li class="routine-step">
                <label class="step-label">
                  <input type="checkbox" 
                         class="step-checkbox" 
                         data-step-id="{{ step.id }}"
                         {% if step.id in today_completed_step_ids %}checked{% endif %}>
                  <span class="step-text">
                    {% if step.product %}
                      {{ step.product.name }} ‚Äì {{ step.step_name }}
                    {% else %}
                      {{ step.step_name }}
                    {% endif %}
                  </span>
                </label>
              </li>
            {% endfor %}
          </ul>
          <div class="routine-actions">
            {% if evening_routine.id %}
              <button class="complete-btn" onclick="markRoutineComplete('{{ evening_routine.id }}', 'evening')">Mark Complete</button>
            {% else %}
              <button class="complete-btn" disabled>No Routine Set</button>
            {% endif %}
          </div>
        {% else %}
          <p>No evening routine yet.</p>
          <a href="{% url 'routines:add' %}?type=evening" class="add-routine-btn">‚ûï Add Evening Routine</a>
        {% endif %}
      </div>
    </div>

    <!-- Accordion Section for other routines -->
    <div class="accordion mt-4" id="routineAccordion">
      <!-- Weekly Routine -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingWeekly">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseWeekly" aria-expanded="false" aria-controls="collapseWeekly">
            Weekly Routine
          </button>
        </h2>
        <div id="collapseWeekly" class="accordion-collapse collapse" aria-labelledby="headingWeekly" data-bs-parent="#routineAccordion">
          <div class="accordion-body">
            <div class="routine-card weekly">
              <div class="routine-header">
                <h3>Weekly Routine</h3>
              </div>
              {% if weekly_routine %}
                <ul class="routine-steps">
                  {% for step in weekly_routine.steps.all %}
                    <li class="routine-step">
                      <label class="step-label">
                        <input type="checkbox" class="step-checkbox" data-step-id="{{ step.id }}" {% if step.id in today_completed_step_ids %}checked{% endif %}>
                        <span class="step-text">
                          {% if step.product %}
                            {{ step.product.name }} ‚Äì {{ step.step_name }}
                          {% else %}
                            {{ step.step_name }}
                          {% endif %}
                        </span>
                      </label>
                    </li>
                  {% endfor %}
                </ul>
                <div class="routine-actions">
                  <button class="complete-btn" onclick="markRoutineComplete('{{ weekly_routine.id }}', 'weekly')">Mark Complete</button>
                  <a href="{% url 'routines:edit' weekly_routine.pk %}" class="add-routine-btn" style="margin-left: 10px;"> Edit your weekly treatment</a>
                </div>
              {% else %}
                <p>No weekly treatment set yet.</p>
                <a href="{% url 'routines:add' %}?type=weekly" class="add-routine-btn">‚ûï Add weekly treatment</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Monthly Routine -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingMonthly">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMonthly" aria-expanded="false" aria-controls="collapseMonthly">
            Monthly Routine
          </button>
        </h2>
        <div id="collapseMonthly" class="accordion-collapse collapse" aria-labelledby="headingMonthly" data-bs-parent="#routineAccordion">
          <div class="accordion-body">
            <div class="routine-card monthly">
              <div class="routine-header">
                <h3>Monthly Routine</h3>
              </div>
              {% if monthly_routine %}
                <ul class="routine-steps">
                  {% for step in monthly_routine.steps.all %}
                    <li class="routine-step">
                      <label class="step-label">
                        <input type="checkbox" class="step-checkbox" data-step-id="{{ step.id }}" {% if step.id in today_completed_step_ids %}checked{% endif %}>
                        <span class="step-text">
                          {% if step.product %}
                            {{ step.product.name }} ‚Äì {{ step.step_name }}
                          {% else %}
                            {{ step.step_name }}
                          {% endif %}
                        </span>
                      </label>
                    </li>
                  {% endfor %}
                </ul>
                <div class="routine-actions">
                  <button class="complete-btn" onclick="markRoutineComplete('{{ monthly_routine.id }}', 'monthly')">Mark Complete</button>
                  <a href="{% url 'routines:edit' monthly_routine.pk %}" class="add-routine-btn" style="margin-left: 10px;"> Edit your monthly treatment</a>
                </div>
              {% else %}
                <p>No monthly treatment set yet.</p>
                <a href="{% url 'routines:add' %}?type=monthly" class="add-routine-btn">‚ûï Add monthly treatment</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Hair Care -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingHair">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHair" aria-expanded="false" aria-controls="collapseHair">
            Hair Care
          </button>
        </h2>
        <div id="collapseHair" class="accordion-collapse collapse" aria-labelledby="headingHair" data-bs-parent="#routineAccordion">
          <div class="accordion-body">
            <div class="routine-card hair">
              <div class="routine-header">
                <h3>Hair Care</h3>
              </div>
              {% if hair_routine %}
                <ul class="routine-steps">
                  {% for step in hair_routine.steps.all %}
                    <li class="routine-step">
                      <label class="step-label">
                        <input type="checkbox" class="step-checkbox" data-step-id="{{ step.id }}" {% if step.id in today_completed_step_ids %}checked{% endif %}>
                        <span class="step-text">
                          {% if step.product %}
                            {{ step.product.name }} ‚Äì {{ step.step_name }}
                          {% else %}
                            {{ step.step_name }}
                          {% endif %}
                        </span>
                      </label>
                    </li>
                  {% endfor %}
                </ul>
                <div class="routine-actions">
                  <button class="complete-btn" onclick="markRoutineComplete('{{ hair_routine.id }}', 'hair')">Mark Complete</button>
                  <a href="{% url 'routines:edit' hair_routine.pk %}" class="add-routine-btn">Edit your hair treatment</a>
                </div>
              {% else %}
                <p>No hair treatment set yet.</p>
                <a href="{% url 'routines:add' %}?type=hair" class="add-routine-btn">‚ûï Add hair treatment</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Body Care -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingBody">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBody" aria-expanded="false" aria-controls="collapseBody">
            Body Care
          </button>
        </h2>
        <div id="collapseBody" class="accordion-collapse collapse" aria-labelledby="headingBody" data-bs-parent="#routineAccordion">
          <div class="accordion-body">
            <div class="routine-card body">
              <div class="routine-header">
                <h3>Body Care</h3>
              </div>
              {% if body_routine %}
                <ul class="routine-steps">
                  {% for step in body_routine.steps.all %}
                    <li class="routine-step">
                      <label class="step-label">
                        <input type="checkbox" class="step-checkbox" data-step-id="{{ step.id }}" {% if step.id in today_completed_step_ids %}checked{% endif %}>
                        <span class="step-text">
                          {% if step.product %}
                            {{ step.product.name }} ‚Äì {{ step.step_name }}
                          {% else %}
                            {{ step.step_name }}
                          {% endif %}
                        </span>
                      </label>
                    </li>
                  {% endfor %}
                </ul>
                <div class="routine-actions">
                  <button class="complete-btn" onclick="markRoutineComplete('{{ body_routine.id }}', 'body')">Mark Complete</button>
                  <a href="{% url 'routines:edit' body_routine.pk %}" class="add-routine-btn" style="margin-left: 10px;"> Edit your body treatment</a>
                </div>
              {% else %}
                <p>No body treatment set yet.</p>
                <a href="{% url 'routines:add' %}?type=body" class="add-routine-btn">‚ûï Add body treatment</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Special Treatments -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingSpecial">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpecial" aria-expanded="false" aria-controls="collapseSpecial">
            Special Treatments
          </button>
        </h2>
        <div id="collapseSpecial" class="accordion-collapse collapse" aria-labelledby="headingSpecial" data-bs-parent="#routineAccordion">
          <div class="accordion-body">
            <div class="routine-card special">
              <div class="routine-header">
                <h3>Special Treatments</h3>
              </div>
              {% if special_routine %}
                <ul class="routine-steps">
                  {% for step in special_routine.steps.all %}
                    <li class="routine-step">
                      <label class="step-label">
                        <input type="checkbox" class="step-checkbox" data-step-id="{{ step.id }}" {% if step.id in today_completed_step_ids %}checked{% endif %}>
                        <span class="step-text">
                          {% if step.product %}
                            {{ step.product.name }} ‚Äì {{ step.step_name }}
                          {% else %}
                            {{ step.step_name }}
                          {% endif %}
                        </span>
                      </label>
                    </li>
                  {% endfor %}
                </ul>
                <div class="routine-actions">
                  <button class="complete-btn" onclick="markRoutineComplete('{{ special_routine.id }}', 'special')">Mark Complete</button>
                  <a href="{% url 'routines:edit' special_routine.pk %}" class="add-routine-btn" style="margin-left: 10px;"> Edit your special treatment</a>
                </div>
              {% else %}
                <p>No special treatment set yet.</p>
                <a href="{% url 'routines:add' %}?type=special" class="add-routine-btn">‚ûï Add special treatment</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Seasonal Treatments -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingSeasonal">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSeasonal" aria-expanded="false" aria-controls="collapseSeasonal">
            Seasonal Treatments
          </button>
        </h2>
        <div id="collapseSeasonal" class="accordion-collapse collapse" aria-labelledby="headingSeasonal" data-bs-parent="#routineAccordion">
          <div class="accordion-body">
            <div class="routine-card seasonal">
              <div class="routine-header">
                <h3>Seasonal Treatments</h3>
              </div>
              {% if seasonal_routine %}
                <ul class="routine-steps">
                  {% for step in seasonal_routine.steps.all %}
                    <li class="routine-step">
                      <label class="step-label">
                        <input type="checkbox" class="step-checkbox" data-step-id="{{ step.id }}" {% if step.id in today_completed_step_ids %}checked{% endif %}>
                        <span class="step-text">
                          {% if step.product %}
                            {{ step.product.name }} ‚Äì {{ step.step_name }}
                          {% else %}
                            {{ step.step_name }}
                          {% endif %}
                        </span>
                      </label>
                    </li>
                  {% endfor %}
                </ul>
                <div class="routine-actions">
                  <button class="complete-btn" onclick="markRoutineComplete('{{ seasonal_routine.id }}', 'seasonal')">Mark Complete</button>
                  <a href="{% url 'routines:edit' seasonal_routine.pk %}" class="add-routine-btn">Edit your seasonal treatment</a>
                </div>
              {% else %}
                <p>No seasonal treatment set yet.</p>
                <a href="{% url 'routines:add' %}?type=seasonal" class="add-routine-btn">‚ûï Add seasonal treatment</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Product Widgets Section -->
  <section class="product-widgets-section">
    <div class="product-widgets">

      <!-- Skin Type Matches Widget -->
      <div class="product-widget skin-type-widget">
        {% if user_skin_type and skin_type_products %}
          <h4>üéØ Perfect for {{ user_skin_type|title }} Skin</h4>
          <div class="product-mini-cards">
            {% for product in skin_type_products %}
              <div class="product-mini-card" 
                   data-tooltip="Rating: {% if product.rating %}{{ product.rating }}/5‚≠ê{% else %}Not rated{% endif %}{% if product.ingredients %} | Ingredients: {{ product.ingredients|truncatewords:5 }}{% endif %}">
                <span class="product-name">{{ product.name }}</span>
                <span class="product-brand">{{ product.brand }}</span>
                {% if product.rating %}
                  <span class="rating">{{ product.rating }}/5‚≠ê</span>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <h4>üéØ Perfect for Your Skin Type</h4>
          <div class="empty-widget">
            {% if not user_skin_type %}
              <p class="empty-message">Set your skin type in your profile to see personalized product recommendations here.</p>
              <a href="{% url 'users:profile_edit' %}" class="btn btn-sm btn-outline-info">Set Skin Type</a>
            {% else %}
              <p class="empty-message">Add products that match your {{ user_skin_type }} skin type to see recommendations here.</p>
              <a href="{% url 'products:create' %}" class="btn btn-sm btn-outline-info">Add Products</a>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <!-- Favorites Widget -->
      <div class="product-widget favorites-widget">
        {% if favorite_products %}
          <h4>üíñ Your Favorites</h4>
          <div class="product-mini-cards">
            {% for product in favorite_products %}
              <div class="product-mini-card"
                   data-tooltip="Rating: {% if product.rating %}{{ product.rating }}/5‚≠ê{% else %}Not rated{% endif %}{% if product.expiry_date %} | Expires: {{ product.expiry_date }}{% endif %}{% if product.ingredients %} | Ingredients: {{ product.ingredients|truncatewords:5 }}{% endif %}">
                <span class="product-name">{{ product.name }}</span>
                <span class="product-brand">{{ product.brand }}</span>
                {% if product.expiry_date %}
                  {% with days_left=product.expiry_date|timeuntil %}
                    {% if days_left %}
                      <span class="expiry-info">{{ days_left }} left</span>
                    {% endif %}
                  {% endwith %}
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <h4>üíñ Your Favorites</h4>
          <div class="empty-widget">
            <p class="empty-message">Mark products as favorites with the üíñ heart to see them here for quick access.</p>
            <a href="{% url 'products:create' %}" class="btn btn-sm btn-outline-pink">Add Favorite Product</a>
          </div>
        {% endif %}
      </div>

      <!-- Expiring Soon Widget -->
      <div class="product-widget expiry-widget">
        {% if expiring_products %}
          <h4>‚ö†Ô∏è Expiring Soon</h4>
          <div class="product-mini-cards">
            {% for product in expiring_products %}
              {% with days_left=product.expiry_date|timeuntil %}
              <div class="product-mini-card expiry-warning"
                   data-tooltip="Expires: {{ product.expiry_date }} | {% if product.rating %}Rating: {{ product.rating }}/5‚≠ê{% endif %}{% if product.ingredients %} | Ingredients: {{ product.ingredients|truncatewords:5 }}{% endif %}">
                <span class="product-name">{{ product.name }}</span>
                <span class="product-brand">{{ product.brand }}</span>
                <span class="expiry-warning-text">{{ days_left }} left</span>
              </div>
              {% endwith %}
            {% endfor %}
          </div>
        {% else %}
          <h4>‚ö†Ô∏è Expiring Soon</h4>
          <div class="empty-widget">
            <p class="empty-message">Products expiring in the next 90 days will appear here so you never waste anything.</p>
            <a href="{% url 'products:create' %}" class="btn btn-sm btn-outline-warning">Add Products with Expiry</a>
          </div>
        {% endif %}
      </div>

    </div>
  </section>

  <!-- Tips Section -->
  <section class="dashboard-section">
    <h2 class="section-title">üí° Skincare Tips</h2>
    <div class="tips-container">
      <div class="tip-card">
        <h4>üíß Hydration Tip</h4>
        <p>Apply moisturizer to slightly damp skin to lock in extra hydration.</p>
      </div>
      <div class="tip-card">
        <h4>üåô Evening Care</h4>
        <p>Remove makeup thoroughly before starting your evening routine for best results.</p>
      </div>
      <div class="tip-card">
        <h4>‚òÄÔ∏è Morning Protection</h4>
        <p>Always finish your morning routine with SPF, even on cloudy days.</p>
      </div>
      <div class="tip-card">
        <h4>üò¥ Beauty Sleep</h4>
        <p>Get 7-8 hours of quality sleep - it's when your skin repairs and regenerates itself.</p>
      </div>
      <div class="tip-card">
        <h4>üå± Ingredient Order</h4>
        <p>Apply thinnest to thickest consistency: serums before moisturizers, oils last.</p>
      </div>
      <div class="tip-card">
        <h4>üîÑ Product Rotation</h4>
        <p>Introduce new active ingredients gradually, one at a time every 2-3 weeks.</p>
      </div>
    </div>
  </section>

  <!-- Calendar Section with isolated styling -->
  <section class="calendar-section" id="calendar-wrapper">
    <h2 class="section-title">Calendar Overview</h2>
    
    <!-- Calendar Legend -->
    <div class="calendar-legend">
      <div class="legend-item">
        <span class="legend-symbol morning">‚òÄÔ∏è</span>
        <span class="legend-text">Morning</span>
      </div>
      <div class="legend-item">
        <span class="legend-symbol evening">üåô</span>
        <span class="legend-text">Evening</span>
      </div>
      <div class="legend-item">
        <span class="legend-symbol complete">‚ú®</span>
        <span class="legend-text">Complete</span>
      </div>
      <div class="legend-item">
        <span class="legend-symbol missed">√ó</span>
        <span class="legend-text">Missed</span>
      </div>
    </div>
    
  <!-- Calendar Section with isolated styling -->
  <section class="calendar-section" id="calendar-wrapper">
    <h2 class="section-title">Calendar Overview</h2>
    <div id="calendar"></div>
  </section>
{% endblock content %}

{% block end_of_body %}
{% endblock end_of_body %}

{% block extra_js %}
<!-- Initialize calendar data from Django backend -->
<script>
  (function() {
    try {
      window.ROUTINE_EVENTS = JSON.parse('{{ routine_events_json|default:"{}"|escapejs }}');
    } catch (e) {
      window.ROUTINE_EVENTS = {};
      console.warn('Could not parse routine events:', e);
    }
    try {
      window.EXPIRY_EVENTS = JSON.parse('{{ expiry_events_json|default:"[]"|escapejs }}');
    } catch (e) {
      window.EXPIRY_EVENTS = [];
      console.warn('Could not parse expiry events:', e);
    }
    
    // Make sure events are loaded before dispatching the event
    window.addEventListener('load', function() {
      // Dispatch the event with routine data for the calendar
      document.dispatchEvent(new CustomEvent('dashboardDataReady', {
        detail: {
          routineData: window.ROUTINE_EVENTS
        }
      }));
      
      console.log('Dashboard data ready event dispatched');
    });
  })();
</script>

{% block after_bootstrap_js %}

<script>
// Dashboard essentials: step completion, routine completion, progress bar

document.addEventListener('DOMContentLoaded', function() {
  // Step completion toggling
  document.querySelectorAll('.step-checkbox').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const stepId = this.getAttribute('data-step-id');
      if (!stepId) return;
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
      if (!csrfToken) return;
      fetch('/routines/toggle-step/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken.value
        },
        body: JSON.stringify({ step_id: stepId })
      })
      .then(r => r.json())
      .then(data => {
        if (!data.success) this.checked = !this.checked;
        updateProgressDisplay();
      })
      .catch(() => { this.checked = !this.checked; });
    });
  });

  // Routine completion
  document.querySelectorAll('.complete-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const routineId = this.getAttribute('data-routine-id');
      const routineType = this.getAttribute('data-routine-type');
      if (!routineId || !routineType) return;
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
      if (!csrfToken) return;
      fetch('/routines/mark-complete/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken.value
        },
        body: JSON.stringify({ routine_id: routineId, routine_type: routineType })
      })
      .then(r => r.json())
      .then(data => { if (data.success) window.location.reload(); });
    });
  });

  // Progress bar update
  const progressBar = document.querySelector('.progress-fill');
  if (progressBar) {
    const progress = progressBar.getAttribute('data-progress') || 0;
    progressBar.style.width = progress + '%';
  }
});

function updateProgressDisplay() {
  // Simple progress update - reload to get accurate progress
  setTimeout(() => window.location.reload(), 500);
}
</script>
{% endblock after_bootstrap_js %}

{% endblock extra_js %}

