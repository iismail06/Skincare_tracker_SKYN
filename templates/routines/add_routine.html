{# routines/add_routine.html - create a new routine and steps #}
{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_editing %}Edit Routine{% else %}Add Routine{% endif %} - SKYN{% endblock %}

{% block content %}
<div class="form-container add-routine-page">
    <div class="back-link-wrap">
        <a href="{% url 'routines:dashboard' %}" class="back-link">‚Üê Back to Dashboard</a>
    </div>
    
    <h1 class="page-title">
        {% if is_editing %}
            {{ page_title }}
        {% else %}
            Create New Routine
        {% endif %}
    </h1>
        {% if just_created_name %}
            <div class="inline-success" role="status" aria-live="polite" style="margin-bottom:1rem;">
                <div class="d-flex" style="align-items:center; gap:.75rem; justify-content:space-between; flex-wrap:wrap;">
                    <div>
                        <strong>{{ just_created_name }}</strong> was added. <span class="muted">You can view it on your dashboard.</span>
                    </div>
                    <div class="actions">
                        <a class="btn btn-primary" href="{% url 'routines:dashboard' %}">View on Dashboard</a>
                    </div>
                </div>
            </div>
        {% endif %}
    
    <div class="form-card">
                {# Display Django form errors inline #}
                {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {% for err in form.non_field_errors %}
                            <div>{{ err }}</div>
                        {% endfor %}
                    </div>
                {% endif %}

                <form method="post" class="routine-form" {% if is_editing %}data-no-ajax="true"{% endif %}>
            {% csrf_token %}
            
                        <div class="form-group">
                <label for="routine_name">Routine Name</label>
                                <input type="text" id="routine_name" name="routine_name" 
                       value="{{ form.routine_name.value|default:'' }}"
                                             placeholder="e.g., My Morning Glow Routine" required list="routine-name-suggestions">
                                <datalist id="routine-name-suggestions"></datalist>
                                {% if form.routine_name.errors %}
                                    <div class="field-error">{{ form.routine_name.errors|striptags }}</div>
                                {% endif %}
            </div>

                        <div class="form-group">
                <label for="routine_type">Routine Type</label>
                <select id="routine_type" name="routine_type" required>
                    <option value="">Choose routine type</option>
                    <option value="morning" {% if form.routine_type.value == 'morning' %}selected{% endif %}>Morning</option>
                    <option value="evening" {% if form.routine_type.value == 'evening' %}selected{% endif %}>Evening</option>
                    <option value="weekly" {% if form.routine_type.value == 'weekly' %}selected{% endif %}>Weekly</option>
                    <option value="monthly" {% if form.routine_type.value == 'monthly' %}selected{% endif %}>Monthly</option>
                    <option value="hair" {% if form.routine_type.value == 'hair' %}selected{% endif %}>Hair</option>
                    <option value="body" {% if form.routine_type.value == 'body' %}selected{% endif %}>Body</option>
                    <option value="special" {% if form.routine_type.value == 'special' %}selected{% endif %}>Special</option>
                    <option value="seasonal" {% if form.routine_type.value == 'seasonal' %}selected{% endif %}>Seasonal</option>
                </select>
                {% if form.routine_type.errors %}
                  <div class="field-error">{{ form.routine_type.errors|striptags }}</div>
                {% endif %}
            </div>

            <div class="steps-section">
                <h3>Routine Steps</h3>
                <p class="steps-help">Add up to 5 steps for your routine (leave blank if not needed)</p>

                <div class="form-group">
                    <label for="step1">Step 1</label>
                    {{ form.step1 }}
                    <label for="product1">Product</label>
                    {{ form.product1 }}
                                        {% if form.step1.errors %}
                                            <div class="field-error">{{ form.step1.errors|striptags }}</div>
                                        {% endif %}
                </div>

                <div class="form-group">
                    <label for="step2">Step 2</label>
                    {{ form.step2 }}
                    <label for="product2">Product</label>
                    {{ form.product2 }}
                                        {% if form.step2.errors %}
                                            <div class="field-error">{{ form.step2.errors|striptags }}</div>
                                        {% endif %}
                </div>

                <div class="form-group">
                    <label for="step3">Step 3</label>
                    {{ form.step3 }}
                    <label for="product3">Product</label>
                    {{ form.product3 }}
                                        {% if form.step3.errors %}
                                            <div class="field-error">{{ form.step3.errors|striptags }}</div>
                                        {% endif %}
                </div>

                <div class="form-group">
                    <label for="step4">Step 4</label>
                    {{ form.step4 }}
                    <label for="product4">Product</label>
                    {{ form.product4 }}
                                        {% if form.step4.errors %}
                                            <div class="field-error">{{ form.step4.errors|striptags }}</div>
                                        {% endif %}
                </div>

                <div class="form-group">
                    <label for="step5">Step 5</label>
                    {{ form.step5 }}
                    <label for="product5">Product</label>
                    {{ form.product5 }}
                                        {% if form.step5.errors %}
                                            <div class="field-error">{{ form.step5.errors|striptags }}</div>
                                        {% endif %}
                </div>

                <!-- Extended steps 6-10 -->
                <div class="form-group">
                    <label for="step6">Step 6</label>
                    {{ form.step6 }}
                    <label for="product6">Product</label>
                    {{ form.product6 }}
                                        {% if form.step6.errors %}
                                            <div class="field-error">{{ form.step6.errors|striptags }}</div>
                                        {% endif %}
                </div>

                <div class="form-group">
                    <label for="step7">Step 7</label>
                    {{ form.step7 }}
                    <label for="product7">Product</label>
                    {{ form.product7 }}
                                        {% if form.step7.errors %}
                                            <div class="field-error">{{ form.step7.errors|striptags }}</div>
                                        {% endif %}
                </div>

                <div class="form-group">
                    <label for="step8">Step 8</label>
                    {{ form.step8 }}
                    <label for="product8">Product</label>
                    {{ form.product8 }}
                                        {% if form.step8.errors %}
                                            <div class="field-error">{{ form.step8.errors|striptags }}</div>
                                        {% endif %}
                </div>

                <div class="form-group">
                    <label for="step9">Step 9</label>
                    {{ form.step9 }}
                    <label for="product9">Product</label>
                    {{ form.product9 }}
                                        {% if form.step9.errors %}
                                            <div class="field-error">{{ form.step9.errors|striptags }}</div>
                                        {% endif %}
                </div>

                <div class="form-group">
                    <label for="step10">Step 10</label>
                    {{ form.step10 }}
                    <label for="product10">Product</label>
                    {{ form.product10 }}
                                        {% if form.step10.errors %}
                                            <div class="field-error">{{ form.step10.errors|striptags }}</div>
                                        {% endif %}
                </div>
            </div>

            <div class="form-actions">
                                <a href="{% url 'routines:dashboard' %}" class="add-routine-btn">Cancel</a>
                                                {% if is_editing %}
                                                    <button type="submit" class="edit-btn">Update Routine</button>
                                                    <!-- Delete button: same glass shell with red border; uses formaction to POST to delete URL -->
                                      <button type="submit"
                                          class="add-routine-btn btn-danger-glass"
                                                                    formaction="{% url 'routines:delete' routine.pk %}"
                                                                    formmethod="post"
                                                                    formnovalidate
                                                  onclick="return confirm('Delete {{ routine.name|escapejs }}? This cannot be undone.');">
                                                        Delete
                                                    </button>
                                                {% else %}
                                    <button type="submit" class="add-routine-btn">
                    {% if is_editing %}
                                                Update Routine
                    {% else %}
                        Create Routine
                    {% endif %}
                                    </button>
                                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}