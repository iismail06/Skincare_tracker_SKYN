{# users/profile.html - main user profile page, shows account info and routines #}
{% extends 'base.html' %}
{% load static %}

{% block title %}Profile | SKYN{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard_style.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="profile-container">
    <h1 class="page-title" style="text-align:center; margin-bottom:2rem;">Welcome, {{ user.first_name|default:user.username }}!</h1>
    <div class="profile-info">
        {% if profile %}
            {% if profile.date_of_birth %}
                <p><strong>Date of Birth:</strong> {{ profile.date_of_birth|date:"F d, Y" }}</p>
            {% endif %}
            {% if profile.skin_type %}
                <p><strong>Skin Type:</strong> {{ profile.get_skin_type_display }}</p>
            {% endif %}
            {% if profile.skin_concerns %}
                <p><strong>Skin Concerns:</strong> {{ profile.skin_concerns }}</p>
            {% endif %}
        {% endif %}
    </div>
    
    <div class="profile-actions">
    <a href="{% url 'users:profile_edit' %}" class="btn btn-secondary">Edit Profile</a>
    <a href="{% url 'routines:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
    </div>

    <div class="profile-routines u-margin-top-xl">
            <h2 style="color:#fff;">My Routines {% if added_ok %}<span class="badge success">Added ✓</span>{% endif %}</h2>
    </div> <!-- /.profile-routines -->
    {% if last_added_routine %}
        <div id="inline-success" class="inline-success inline-success-bottom">
            <div>
                <small class="muted-success">Added</small>
                <div><strong id="inline-success-name">{{ last_added_routine.name }}</strong></div>
            </div>
            <div class="inline-success-actions">
                <a id="inline-success-view" href="{% url 'routines:dashboard' %}" class="btn btn-secondary">View</a>
                <button type="button" class="inline-dismiss" id="inline-success-dismiss" aria-label="Dismiss">✕</button>
            </div>
        </div>
    {% endif %}
            <!-- Inline add-routine form (consolidated) -->
            <div class="form-card">
                <form id="add-routine-form" method="post" action="{% url 'routines:add' %}" class="routine-form" data-ajax-url="{% url 'routines:add' %}">
                    {% csrf_token %}
                    {% comment %} If the view attached a form (`added_routine_form`), use it to show errors. Otherwise show blank inputs. {% endcomment %}
                    {% if added_routine_form %}
                        {% with form=added_routine_form %}
                            {% if form.non_field_errors %}
                                <div class="form-errors non-field-errors">
                                    {% for err in form.non_field_errors %}
                                        <div class="error">{{ err }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}

                            <div class="form-group">
                                <label for="routine_name">Routine name</label>
                                <div class="dropdown-input-wrap">
                                    <input type="text" id="routine_name" name="routine_name" value="{{ added_routine_form.data.routine_name|default_if_none:'' }}" list="routine-name-options" autocomplete="off" required>
                                    <span class="dropdown-arrow">&#9662;</span>
                                </div>
                                <datalist id="routine-name-options">
                                    <option value="Busy Morning">
                                    <option value="Morning Routine for Work">
                                    <option value="Morning Routine for School">
                                    <option value="Morning Shift">
                                    <option value="Busy Night">
                                    <option value="Weekend Glow">
                                    <option value="Holiday Routine">
                                    <option value="Night Shift">
                                    <option value="Quick Refresh">
                                    <option value="Self-Care Sunday">
                                    <option value="After Workout">
                                    <option value="Travel Mode">
                                </datalist>
                                {% if form.errors.routine_name %}
                                    <div class="error">{{ form.errors.routine_name|join:", " }}</div>
                                {% endif %}
                            </div>

                            <div class="form-group">
                                <label for="routine_type">Type</label>
                                <select id="routine_type" name="routine_type" required>
                                    <option value="">Choose</option>
                                    <option value="morning" {% if added_routine_form.data.routine_type == 'morning' %}selected{% endif %}>Morning</option>
                                    <option value="evening" {% if added_routine_form.data.routine_type == 'evening' %}selected{% endif %}>Evening</option>
                                </select>
                                {% if form.errors.routine_type %}
                                    <div class="error">{{ form.errors.routine_type|join:", " }}</div>
                                {% endif %}
                            </div>

                            <div class="steps-section">
                                <label>Steps (up to 5)</label>
                                <select id="step1" name="step1" class="step-select"></select>
                                <select id="step2" name="step2" class="step-select"></select>
                                <select id="step3" name="step3" class="step-select"></select>
                                <select id="step4" name="step4" class="step-select"></select>
                                <select id="step5" name="step5" class="step-select"></select>
                            </div>

                                <div class="form-actions">
                                <button type="submit" class="btn btn-secondary" id="add-routine-submit">Add Routine</button>
                            </div>
                        {% endwith %}
                    {% else %}
                        <div class="form-group">
                            <label for="routine_name">Routine name</label>
                            <div class="dropdown-input-wrap">
                                <input type="text" id="routine_name" name="routine_name" placeholder="e.g., Morning Glow" required list="routine-name-options" autocomplete="off">
                                <span class="dropdown-arrow">&#9662;</span>
                            </div>
                            <datalist id="routine-name-options">
                                <option value="Busy Morning">
                                <option value="Morning Routine for Work">
                                <option value="Morning Routine for School">
                                <option value="Morning Shift">
                                <option value="Busy Night">
                                <option value="Weekend Glow">
                                <option value="Holiday Routine">
                                <option value="Night Shift">
                                <option value="Quick Refresh">
                                <option value="Self-Care Sunday">
                                <option value="After Workout">
                                <option value="Travel Mode">
                            </datalist>
                        </div>
                        <div class="form-group">
                            <label for="routine_type">Type</label>
                            <select id="routine_type" name="routine_type" required>
                                <option value="">Choose</option>
                                <option value="morning">Morning</option>
                                <option value="evening">Evening</option>
                            </select>
                        </div>
                        <div class="steps-section">
                            <label>Steps (up to 5)</label>
                            <select id="step1" name="step1" class="step-select"></select>
                            <select id="step2" name="step2" class="step-select"></select>
                            <select id="step3" name="step3" class="step-select"></select>
                            <select id="step4" name="step4" class="step-select"></select>
                            <select id="step5" name="step5" class="step-select"></select>
                        </div>
                        <div class="form-actions u-margin-top-sm">
                            <button type="submit" class="btn btn-secondary" id="add-routine-submit">Add Routine</button>
                        </div>
                    {% endif %}
                </form>
            </div>
            {% if routines %}
                <ul class="routines-list">
                    {% for routine in routines %}
                        <li>
                            <strong>{{ routine.name }}</strong> - {{ routine.routine_type|title }}
                            <button type="button" class="btn btn-secondary edit-btn" 
                                    data-routine-id="{{ routine.pk }}" 
                                    data-routine-name="{{ routine.name|escapejs }}" 
                                    data-routine-type="{{ routine.routine_type }}">
                                Edit
                            </button>
                            <a href="{% url 'routines:dashboard' %}" class="btn btn-secondary">View</a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No routines found. <a href="#" class="btn btn-secondary add-routine-cta">Add a Routine</a></p>
            {% endif %}
    </div>
    </div> 
</div>

<!-- Edit Routine Modal -->
<div class="modal fade" id="editRoutineModal" tabindex="-1" aria-labelledby="editRoutineModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editRoutineModalLabel">Edit Routine</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="editRoutineForm">
        {% csrf_token %}
        <input type="hidden" id="edit-routine-id" name="routine_id" value="">
        <input type="hidden" name="action" value="edit_routine">
        <div class="modal-body">
          <div class="mb-3">
            <label for="edit-routine-name" class="form-label">Routine Name</label>
            <input type="text" class="form-control" id="edit-routine-name" name="routine_name" required>
          </div>
          <div class="mb-3">
            <label for="edit-routine-type" class="form-label">Routine Type</label>
            <select class="form-select" id="edit-routine-type" name="routine_type" required>
              <option value="">Choose routine type</option>
              <option value="morning">Morning</option>
              <option value="evening">Evening</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="hair">Hair</option>
              <option value="body">Body</option>
              <option value="special">Special</option>
              <option value="seasonal">Seasonal</option>
            </select>
          </div>
          <div class="steps-section">
            <h6>Routine Steps</h6>
            <p class="text-muted small">Add up to 5 steps for your routine (leave blank if not needed)</p>
            {% for i in "12345" %}
              <div class="row mb-2">
                <div class="col-md-6">
                  <label for="edit-step{{ i }}" class="form-label">Step {{ i }}</label>
                  <input type="text" class="form-control" id="edit-step{{ i }}" name="step{{ i }}" placeholder="Step description">
                </div>
                <div class="col-md-6">
                  <label for="edit-product{{ i }}" class="form-label">Product (optional)</label>
                  <select class="form-select" id="edit-product{{ i }}" name="product{{ i }}">
                    <option value="">-- No product selected --</option>
                    {% for product in user.products.all %}
                      <option value="{{ product.id }}">{{ product.brand }} - {{ product.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Initialize user products data for JS -->
<script id="user-products-data" type="application/json">
{{ user_products_json|safe }}
</script>

<!-- Initialize profile page JavaScript -->
<script>
  (function() {
    try {
      // Expose user's products to JS so the edit modal can show suggestions without extra network calls
      window.USER_PRODUCTS = JSON.parse(document.getElementById('user-products-data').textContent);
      // Convert to desired format: [{id:..., label:...}, ...]
      window.USER_PRODUCTS = window.USER_PRODUCTS.map(function(p) {
        return { id: p[0], label: p[1] + ' - ' + p[2] };
      });
      document.dispatchEvent(new CustomEvent('profileDataReady'));
    } catch (e) {
      window.USER_PRODUCTS = [];
    }
  })();
</script>

<script src="{% static 'js/main.js' %}"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}